<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ªå®šä¹‰çŸ¥è¯†ç‚¹æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .form-group {
            margin: 15px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: inherit;
        }
        textarea {
            height: 100px;
            resize: vertical;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 16px;
        }
        button:hover {
            background: #2980b9;
        }
        button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }
        .result {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            white-space: pre-wrap;
            display: none;
        }
        .success {
            background: #d5f4e6;
            border-left: 4px solid #27ae60;
        }
        .error {
            background: #fdf2f2;
            border-left: 4px solid #e74c3c;
        }
        .loading {
            color: #f39c12;
        }
        .step {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .step h3 {
            margin-top: 0;
            color: #2c3e50;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¨ è‡ªå®šä¹‰çŸ¥è¯†ç‚¹æµ‹è¯•</h1>
        <p>æµ‹è¯•ç”¨æˆ·è¾“å…¥ä»»æ„çŸ¥è¯†ç‚¹çš„ä¸¤æ­¥ç”ŸæˆåŠŸèƒ½</p>

        <!-- æ­¥éª¤1: è¾“å…¥è‡ªå®šä¹‰çŸ¥è¯†ç‚¹ -->
        <div class="step">
            <h3>ğŸ“ æ­¥éª¤1: è¾“å…¥ä»»æ„çŸ¥è¯†ç‚¹</h3>
            
            <div class="form-group">
                <label>çŸ¥è¯†ç‚¹å†…å®¹:</label>
                <textarea id="knowledgePoint" placeholder="è¯·è¾“å…¥ä»»æ„çŸ¥è¯†ç‚¹ï¼Œä¾‹å¦‚ï¼š
â€¢ æ•°å­¦ï¼šåŠ æ³•è¿ç®—ã€å‡ ä½•å›¾å½¢ã€åˆ†æ•°æ¦‚å¿µ
â€¢ ç§‘å­¦ï¼šå…‰çš„æŠ˜å°„ã€ç»†èƒåˆ†è£‚ã€åŒ–å­¦ååº”
â€¢ å†å²ï¼šå¤ä»£æ–‡æ˜ã€å†å²äº‹ä»¶ã€æ–‡åŒ–ä¼ ç»Ÿ
â€¢ è¯­è¨€ï¼šè¯­æ³•è§„åˆ™ã€è¯æ±‡å­¦ä¹ ã€æ–‡å­¦ä½œå“
â€¢ å…¶ä»–ä»»æ„å­¦ç§‘çŸ¥è¯†ç‚¹...">å…‰çš„æŠ˜å°„åŸç†</textarea>
            </div>

            <div class="form-group">
                <label>å¹´é¾„ç»„:</label>
                <select id="ageGroup">
                    <option value="0">å­¦é¾„å‰ (3-5å²)</option>
                    <option value="1" selected>å°å­¦ (6-11å²)</option>
                    <option value="2">ä¸­å­¦ (12-14å²)</option>
                    <option value="3">é«˜ä¸­ (15-18å²)</option>
                </select>
            </div>

            <div class="form-group">
                <label>é¢æ¿æ•°é‡:</label>
                <input type="number" id="panelCount" value="4" min="3" max="6">
            </div>

            <div class="form-group">
                <label>è§†è§‰é£æ ¼:</label>
                <select id="visualStyle">
                    <option value="0" selected>å¡é€šé£æ ¼</option>
                    <option value="1">å†™å®é£æ ¼</option>
                    <option value="2">ç®€çº¦é£æ ¼</option>
                    <option value="3">å¤šå½©é£æ ¼</option>
                </select>
            </div>

            <button onclick="generatePrompt()" id="generateBtn">ğŸ¯ ç”Ÿæˆæç¤ºè¯</button>
            <div id="promptResult" class="result"></div>
        </div>

        <!-- æ­¥éª¤2: ç¼–è¾‘æç¤ºè¯ -->
        <div class="step">
            <h3>âœï¸ æ­¥éª¤2: ç¼–è¾‘ç”Ÿæˆçš„æç¤ºè¯</h3>
            <textarea id="promptEditor" placeholder="ç”Ÿæˆçš„æç¤ºè¯å°†æ˜¾ç¤ºåœ¨è¿™é‡Œï¼Œæ‚¨å¯ä»¥ç¼–è¾‘..."></textarea>
            <br>
            <button onclick="validatePrompt()" id="validateBtn" disabled>âœ… éªŒè¯æç¤ºè¯</button>
            <button onclick="generateComic()" id="generateComicBtn" disabled>ğŸ–¼ï¸ ç”Ÿæˆæ¼«ç”»</button>
            <div id="validationResult" class="result"></div>
        </div>

        <!-- æ­¥éª¤3: æ¼«ç”»ç»“æœ -->
        <div class="step">
            <h3>ğŸ¨ æ­¥éª¤3: ç”Ÿæˆçš„æ¼«ç”»</h3>
            <div id="comicResult" class="result"></div>
        </div>

        <!-- æµ‹è¯•ç”¨ä¾‹ -->
        <div class="step">
            <h3>ğŸ§ª å¿«é€Ÿæµ‹è¯•ç”¨ä¾‹</h3>
            <p>ç‚¹å‡»ä¸‹é¢çš„æŒ‰é’®å¿«é€Ÿæµ‹è¯•ä¸åŒç±»å‹çš„çŸ¥è¯†ç‚¹ï¼š</p>
            <button onclick="testCase('æ•°å­¦', 'åˆ†æ•°çš„æ¦‚å¿µå’Œåº”ç”¨')">æ•°å­¦ï¼šåˆ†æ•°æ¦‚å¿µ</button>
            <button onclick="testCase('ç§‘å­¦', 'æ¤ç‰©çš„å…‰åˆä½œç”¨è¿‡ç¨‹')">ç§‘å­¦ï¼šå…‰åˆä½œç”¨</button>
            <button onclick="testCase('å†å²', 'ä¸­å›½å¤ä»£å››å¤§å‘æ˜')">å†å²ï¼šå››å¤§å‘æ˜</button>
            <button onclick="testCase('è¯­è¨€', 'è‹±è¯­è¿‡å»æ—¶æ€çš„ç”¨æ³•')">è¯­è¨€ï¼šè¿‡å»æ—¶æ€</button>
            <button onclick="testCase('è‰ºæœ¯', 'è‰²å½©æ­é…çš„åŸºæœ¬åŸç†')">è‰ºæœ¯ï¼šè‰²å½©æ­é…</button>
        </div>
    </div>

    <script>
        const API_BASE = 'https://localhost:7109';
        let currentPromptId = '';
        let currentOptions = {};

        // æµ‹è¯•ç”¨ä¾‹
        function testCase(subject, content) {
            document.getElementById('knowledgePoint').value = content;
            showMessage(`å·²è®¾ç½®æµ‹è¯•ç”¨ä¾‹ï¼š${subject} - ${content}`, 'success');
        }

        // ç”Ÿæˆæç¤ºè¯
        async function generatePrompt() {
            const btn = document.getElementById('generateBtn');
            const result = document.getElementById('promptResult');
            const knowledgePoint = document.getElementById('knowledgePoint').value.trim();
            
            if (!knowledgePoint) {
                showMessage('è¯·è¾“å…¥çŸ¥è¯†ç‚¹å†…å®¹', 'error');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'ğŸ”„ ç”Ÿæˆä¸­...';
            result.style.display = 'block';
            result.className = 'result loading';
            result.textContent = 'æ­£åœ¨ç”Ÿæˆæç¤ºè¯ï¼Œè¯·ç¨å€™...';

            try {
                const requestData = {
                    MathConcept: knowledgePoint,
                    Options: {
                        PanelCount: parseInt(document.getElementById('panelCount').value),
                        AgeGroup: parseInt(document.getElementById('ageGroup').value),
                        VisualStyle: parseInt(document.getElementById('visualStyle').value),
                        Language: 0 // Chinese
                    }
                };

                console.log('å‘é€è¯·æ±‚:', requestData);

                const response = await fetch(`${API_BASE}/api/comic/generate-prompt`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                console.log('å“åº”çŠ¶æ€:', response.status);

                if (response.ok) {
                    const data = await response.json();
                    console.log('å“åº”æ•°æ®:', data);
                    
                    const promptData = data.data;
                    
                    currentPromptId = promptData.id;
                    currentOptions = promptData.options;
                    
                    document.getElementById('promptEditor').value = promptData.generatedPrompt;
                    document.getElementById('validateBtn').disabled = false;
                    document.getElementById('generateComicBtn').disabled = false;
                    
                    result.className = 'result success';
                    result.textContent = `âœ… æç¤ºè¯ç”ŸæˆæˆåŠŸï¼
çŸ¥è¯†ç‚¹: ${promptData.mathConcept}
ID: ${promptData.id}
åˆ›å»ºæ—¶é—´: ${new Date(promptData.createdAt).toLocaleString()}

ç”Ÿæˆçš„æç¤ºè¯:
${promptData.generatedPrompt}

æ”¹è¿›å»ºè®®:
${promptData.suggestions.map(s => `â€¢ ${s}`).join('\n')}`;
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'ç”Ÿæˆå¤±è´¥');
                }
            } catch (error) {
                console.error('ç”Ÿæˆé”™è¯¯:', error);
                result.className = 'result error';
                result.textContent = `âŒ ç”Ÿæˆå¤±è´¥: ${error.message}`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸ¯ ç”Ÿæˆæç¤ºè¯';
            }
        }

        // éªŒè¯æç¤ºè¯
        async function validatePrompt() {
            const btn = document.getElementById('validateBtn');
            const result = document.getElementById('validationResult');
            const prompt = document.getElementById('promptEditor').value;

            if (!prompt.trim()) {
                showMessage('è¯·å…ˆè¾“å…¥æç¤ºè¯', 'error');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'ğŸ”„ éªŒè¯ä¸­...';
            result.style.display = 'block';
            result.className = 'result loading';
            result.textContent = 'æ­£åœ¨éªŒè¯æç¤ºè¯...';

            try {
                const response = await fetch(`${API_BASE}/api/comic/validate-prompt`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ Prompt: prompt })
                });

                if (response.ok) {
                    const data = await response.json();
                    const validationData = data.data;
                    
                    if (validationData.isValid) {
                        result.className = 'result success';
                        result.textContent = 'âœ… æç¤ºè¯éªŒè¯é€šè¿‡ï¼å¯ä»¥ç”Ÿæˆæ¼«ç”»ã€‚';
                    } else {
                        result.className = 'result error';
                        result.textContent = `âŒ æç¤ºè¯éªŒè¯å¤±è´¥: ${validationData.errorMessage}
                        
å»ºè®®:
${validationData.suggestions?.map(s => `â€¢ ${s}`).join('\n') || 'æ— '}`;
                    }
                } else {
                    throw new Error('éªŒè¯è¯·æ±‚å¤±è´¥');
                }
            } catch (error) {
                result.className = 'result error';
                result.textContent = `âŒ éªŒè¯å¤±è´¥: ${error.message}`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'âœ… éªŒè¯æç¤ºè¯';
            }
        }

        // ç”Ÿæˆæ¼«ç”»
        async function generateComic() {
            const btn = document.getElementById('generateComicBtn');
            const result = document.getElementById('comicResult');
            const prompt = document.getElementById('promptEditor').value;

            if (!prompt.trim()) {
                showMessage('è¯·å…ˆè¾“å…¥æç¤ºè¯', 'error');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'ğŸ”„ ç”Ÿæˆä¸­...';
            result.style.display = 'block';
            result.className = 'result loading';
            result.textContent = 'æ­£åœ¨ç”Ÿæˆæ¼«ç”»ï¼Œè¯·ç¨å€™...';

            try {
                const requestData = {
                    PromptId: currentPromptId,
                    EditedPrompt: prompt,
                    Options: currentOptions
                };

                const response = await fetch(`${API_BASE}/api/comic/generate-from-prompt`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                if (response.ok) {
                    const data = await response.json();
                    const comicData = data.data;
                    
                    result.className = 'result success';
                    result.textContent = `âœ… æ¼«ç”»ç”ŸæˆæˆåŠŸï¼
ID: ${comicData.id}
æ ‡é¢˜: ${comicData.title}
é¢æ¿æ•°é‡: ${comicData.panels.length}
åˆ›å»ºæ—¶é—´: ${new Date(comicData.createdAt).toLocaleString()}

é¢æ¿é¢„è§ˆ:
${comicData.panels.map((panel, i) => 
    `é¢æ¿ ${i + 1}:
    å¯¹è¯: ${panel.dialogue?.join('; ') || 'æ— '}
    æ—ç™½: ${panel.narration || 'æ— '}`
).join('\n\n')}`;
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'ç”Ÿæˆå¤±è´¥');
                }
            } catch (error) {
                result.className = 'result error';
                result.textContent = `âŒ ç”Ÿæˆå¤±è´¥: ${error.message}`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸ–¼ï¸ ç”Ÿæˆæ¼«ç”»';
            }
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type) {
            const result = document.getElementById('promptResult');
            result.style.display = 'block';
            result.className = `result ${type}`;
            result.textContent = message;
            
            if (type === 'success') {
                setTimeout(() => {
                    result.style.display = 'none';
                }, 3000);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆ
        window.onload = function() {
            console.log('è‡ªå®šä¹‰çŸ¥è¯†ç‚¹æµ‹è¯•é¡µé¢å·²åŠ è½½');
            showMessage('é¡µé¢å·²åŠ è½½ï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•ä»»æ„çŸ¥è¯†ç‚¹çš„ä¸¤æ­¥ç”ŸæˆåŠŸèƒ½ï¼', 'success');
        };
    </script>
</body>
</html>