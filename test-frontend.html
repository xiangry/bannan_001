<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°å­¦æ¼«ç”»ç”Ÿæˆå™¨ - åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .step {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .step h3 {
            color: #2c3e50;
            margin-top: 0;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #2980b9;
        }
        button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }
        .result {
            background: #ecf0f1;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            white-space: pre-wrap;
        }
        .success {
            background: #d5f4e6;
            border-left: 4px solid #27ae60;
        }
        .error {
            background: #fdf2f2;
            border-left: 4px solid #e74c3c;
        }
        .loading {
            color: #f39c12;
        }
        textarea {
            width: 100%;
            height: 150px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: inherit;
        }
        .form-group {
            margin: 10px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        select, input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
            margin: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¨ æ•°å­¦æ¼«ç”»ç”Ÿæˆå™¨ - ä¸¤æ­¥ç”Ÿæˆæµç¨‹æµ‹è¯•</h1>
        
        <!-- æ­¥éª¤1: è¾“å…¥æ•°å­¦æ¦‚å¿µ -->
        <div class="step">
            <h3>ğŸ“ æ­¥éª¤1: è¾“å…¥æ•°å­¦æ¦‚å¿µå’Œé€‰é¡¹</h3>
            <div class="form-group">
                <label>æ•°å­¦æ¦‚å¿µ:</label>
                <input type="text" id="mathConcept" value="åˆ†æ•°æ¦‚å¿µ" placeholder="ä¾‹å¦‚ï¼šåŠ æ³•è¿ç®—ã€å‡ ä½•å›¾å½¢ã€åˆ†æ•°æ¦‚å¿µ...">
            </div>
            <div class="form-group">
                <label>å¹´é¾„ç»„:</label>
                <select id="ageGroup">
                    <option value="0">å­¦é¾„å‰ (3-5å²)</option>
                    <option value="1" selected>å°å­¦ (6-11å²)</option>
                    <option value="2">ä¸­å­¦ (12-14å²)</option>
                    <option value="3">é«˜ä¸­ (15-18å²)</option>
                </select>
                
                <label>é¢æ¿æ•°é‡:</label>
                <input type="number" id="panelCount" value="4" min="3" max="6">
                
                <label>è§†è§‰é£æ ¼:</label>
                <select id="visualStyle">
                    <option value="0" selected>å¡é€šé£æ ¼</option>
                    <option value="1">å†™å®é£æ ¼</option>
                    <option value="2">ç®€çº¦é£æ ¼</option>
                    <option value="3">å¤šå½©é£æ ¼</option>
                </select>
            </div>
            <button onclick="generatePrompt()" id="generatePromptBtn">ğŸ¯ ç”Ÿæˆæç¤ºè¯</button>
            <div id="promptResult" class="result" style="display:none;"></div>
        </div>

        <!-- æ­¥éª¤2: ç¼–è¾‘æç¤ºè¯ -->
        <div class="step">
            <h3>âœï¸ æ­¥éª¤2: ç¼–è¾‘æç¤ºè¯</h3>
            <textarea id="promptEditor" placeholder="ç”Ÿæˆçš„æç¤ºè¯å°†æ˜¾ç¤ºåœ¨è¿™é‡Œï¼Œæ‚¨å¯ä»¥ç¼–è¾‘..."></textarea>
            <br>
            <button onclick="validatePrompt()" id="validateBtn" disabled>âœ… éªŒè¯æç¤ºè¯</button>
            <button onclick="optimizePrompt()" id="optimizeBtn" disabled>ğŸ”§ ä¼˜åŒ–æç¤ºè¯</button>
            <div id="validationResult" class="result" style="display:none;"></div>
        </div>

        <!-- æ­¥éª¤3: ç”Ÿæˆæ¼«ç”» -->
        <div class="step">
            <h3>ğŸ¨ æ­¥éª¤3: ç”Ÿæˆæ¼«ç”»å›¾ç‰‡</h3>
            <button onclick="generateComic()" id="generateComicBtn" disabled>ğŸ–¼ï¸ ç”Ÿæˆæ¼«ç”»å›¾ç‰‡</button>
            <div id="comicResult" class="result" style="display:none;"></div>
        </div>

        <!-- ç³»ç»ŸçŠ¶æ€ -->
        <div class="step">
            <h3>ğŸ“Š ç³»ç»ŸçŠ¶æ€</h3>
            <button onclick="checkStatus()">ğŸ” æ£€æŸ¥APIçŠ¶æ€</button>
            <button onclick="getComicList()">ğŸ“š è·å–æ¼«ç”»åˆ—è¡¨</button>
            <div id="statusResult" class="result" style="display:none;"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://localhost:7109';
        let currentPromptId = '';
        let currentOptions = {};

        // ç”Ÿæˆæç¤ºè¯
        async function generatePrompt() {
            const btn = document.getElementById('generatePromptBtn');
            const result = document.getElementById('promptResult');
            
            btn.disabled = true;
            btn.textContent = 'ğŸ”„ ç”Ÿæˆä¸­...';
            result.style.display = 'block';
            result.className = 'result loading';
            result.textContent = 'æ­£åœ¨ç”Ÿæˆæç¤ºè¯ï¼Œè¯·ç¨å€™...';

            try {
                const requestData = {
                    MathConcept: document.getElementById('mathConcept').value,
                    Options: {
                        PanelCount: parseInt(document.getElementById('panelCount').value),
                        AgeGroup: parseInt(document.getElementById('ageGroup').value),
                        VisualStyle: parseInt(document.getElementById('visualStyle').value),
                        Language: 0 // Chinese
                    }
                };

                const response = await fetch(`${API_BASE}/api/comic/generate-prompt`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                if (response.ok) {
                    const data = await response.json();
                    const promptData = data.data;
                    
                    currentPromptId = promptData.id;
                    currentOptions = promptData.options;
                    
                    document.getElementById('promptEditor').value = promptData.generatedPrompt;
                    document.getElementById('validateBtn').disabled = false;
                    document.getElementById('optimizeBtn').disabled = false;
                    
                    result.className = 'result success';
                    result.textContent = `âœ… æç¤ºè¯ç”ŸæˆæˆåŠŸï¼
ID: ${promptData.id}
æ•°å­¦æ¦‚å¿µ: ${promptData.mathConcept}
åˆ›å»ºæ—¶é—´: ${new Date(promptData.createdAt).toLocaleString()}

æ”¹è¿›å»ºè®®:
${promptData.suggestions.map(s => `â€¢ ${s}`).join('\\n')}`;
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.data?.error || 'ç”Ÿæˆå¤±è´¥');
                }
            } catch (error) {
                result.className = 'result error';
                result.textContent = `âŒ ç”Ÿæˆå¤±è´¥: ${error.message}`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸ¯ ç”Ÿæˆæç¤ºè¯';
            }
        }

        // éªŒè¯æç¤ºè¯
        async function validatePrompt() {
            const btn = document.getElementById('validateBtn');
            const result = document.getElementById('validationResult');
            const prompt = document.getElementById('promptEditor').value;

            if (!prompt.trim()) {
                alert('è¯·å…ˆè¾“å…¥æç¤ºè¯');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'ğŸ”„ éªŒè¯ä¸­...';
            result.style.display = 'block';
            result.className = 'result loading';
            result.textContent = 'æ­£åœ¨éªŒè¯æç¤ºè¯...';

            try {
                const response = await fetch(`${API_BASE}/api/comic/validate-prompt`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ Prompt: prompt })
                });

                if (response.ok) {
                    const data = await response.json();
                    const validationData = data.data;
                    
                    if (validationData.isValid) {
                        result.className = 'result success';
                        result.textContent = 'âœ… æç¤ºè¯éªŒè¯é€šè¿‡ï¼å¯ä»¥ç”Ÿæˆæ¼«ç”»ã€‚';
                        document.getElementById('generateComicBtn').disabled = false;
                    } else {
                        result.className = 'result error';
                        result.textContent = `âŒ æç¤ºè¯éªŒè¯å¤±è´¥: ${validationData.errorMessage}
                        
å»ºè®®:
${validationData.suggestions?.map(s => `â€¢ ${s}`).join('\\n') || 'æ— '}`;
                    }
                } else {
                    throw new Error('éªŒè¯è¯·æ±‚å¤±è´¥');
                }
            } catch (error) {
                result.className = 'result error';
                result.textContent = `âŒ éªŒè¯å¤±è´¥: ${error.message}`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'âœ… éªŒè¯æç¤ºè¯';
            }
        }

        // ä¼˜åŒ–æç¤ºè¯
        async function optimizePrompt() {
            const btn = document.getElementById('optimizeBtn');
            const prompt = document.getElementById('promptEditor').value;

            if (!prompt.trim()) {
                alert('è¯·å…ˆè¾“å…¥æç¤ºè¯');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'ğŸ”„ ä¼˜åŒ–ä¸­...';

            try {
                const response = await fetch(`${API_BASE}/api/comic/optimize-prompt`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        Prompt: prompt,
                        Options: currentOptions 
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('promptEditor').value = data.optimizedPrompt;
                    alert('âœ… æç¤ºè¯ä¼˜åŒ–å®Œæˆï¼');
                } else {
                    throw new Error('ä¼˜åŒ–è¯·æ±‚å¤±è´¥');
                }
            } catch (error) {
                alert(`âŒ ä¼˜åŒ–å¤±è´¥: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸ”§ ä¼˜åŒ–æç¤ºè¯';
            }
        }

        // ç”Ÿæˆæ¼«ç”»
        async function generateComic() {
            const btn = document.getElementById('generateComicBtn');
            const result = document.getElementById('comicResult');
            const prompt = document.getElementById('promptEditor').value;

            if (!prompt.trim()) {
                alert('è¯·å…ˆè¾“å…¥æç¤ºè¯');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'ğŸ”„ ç”Ÿæˆä¸­...';
            result.style.display = 'block';
            result.className = 'result loading';
            result.textContent = 'æ­£åœ¨ç”Ÿæˆæ¼«ç”»ï¼Œè¯·ç¨å€™...';

            try {
                const requestData = {
                    PromptId: currentPromptId,
                    EditedPrompt: prompt,
                    Options: currentOptions
                };

                const response = await fetch(`${API_BASE}/api/comic/generate-from-prompt`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                if (response.ok) {
                    const data = await response.json();
                    const comicData = data.data;
                    
                    result.className = 'result success';
                    result.textContent = `âœ… æ¼«ç”»ç”ŸæˆæˆåŠŸï¼
ID: ${comicData.id}
æ ‡é¢˜: ${comicData.title}
é¢æ¿æ•°é‡: ${comicData.panels.length}
åˆ›å»ºæ—¶é—´: ${new Date(comicData.createdAt).toLocaleString()}

é¢æ¿é¢„è§ˆ:
${comicData.panels.map((panel, i) => 
    `é¢æ¿ ${i + 1}:
    å¯¹è¯: ${panel.dialogue?.join('; ') || 'æ— '}
    æ—ç™½: ${panel.narration || 'æ— '}`
).join('\\n\\n')}`;
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.data?.error || 'ç”Ÿæˆå¤±è´¥');
                }
            } catch (error) {
                result.className = 'result error';
                result.textContent = `âŒ ç”Ÿæˆå¤±è´¥: ${error.message}`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸ–¼ï¸ ç”Ÿæˆæ¼«ç”»å›¾ç‰‡';
            }
        }

        // æ£€æŸ¥APIçŠ¶æ€
        async function checkStatus() {
            const result = document.getElementById('statusResult');
            result.style.display = 'block';
            result.className = 'result loading';
            result.textContent = 'æ­£åœ¨æ£€æŸ¥APIçŠ¶æ€...';

            try {
                const response = await fetch(`${API_BASE}/api/comic/config-status`);
                
                if (response.ok) {
                    const data = await response.json();
                    const config = data.data;
                    
                    result.className = 'result success';
                    result.textContent = `âœ… APIçŠ¶æ€æ­£å¸¸
é…ç½®æœ‰æ•ˆæ€§: ${config.isValid ? 'âœ… æœ‰æ•ˆ' : 'âŒ æ— æ•ˆ'}
APIå¯†é’¥: ${config.configuration.GeminiAPI.hasApiKey ? 'âœ… å·²é…ç½®' : 'âŒ æœªé…ç½®'}
åŸºç¡€URL: ${config.configuration.GeminiAPI.baseUrl}
æœ€å¤§å¹¶å‘: ${config.configuration.ResourceManagement.maxConcurrentRequests}
æ£€æŸ¥æ—¶é—´: ${new Date(config.timestamp).toLocaleString()}`;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                result.className = 'result error';
                result.textContent = `âŒ APIçŠ¶æ€æ£€æŸ¥å¤±è´¥: ${error.message}`;
            }
        }

        // è·å–æ¼«ç”»åˆ—è¡¨
        async function getComicList() {
            const result = document.getElementById('statusResult');
            result.style.display = 'block';
            result.className = 'result loading';
            result.textContent = 'æ­£åœ¨è·å–æ¼«ç”»åˆ—è¡¨...';

            try {
                const response = await fetch(`${API_BASE}/api/comic`);
                
                if (response.ok) {
                    const data = await response.json();
                    const comics = data.data;
                    
                    result.className = 'result success';
                    result.textContent = `âœ… æ¼«ç”»åˆ—è¡¨è·å–æˆåŠŸ
æ€»æ•°é‡: ${comics.length}

${comics.length > 0 ? 
    comics.map(comic => 
        `â€¢ ${comic.mathConcept} (${new Date(comic.createdAt).toLocaleDateString()})`
    ).join('\\n') : 
    'æš‚æ— æ¼«ç”»'}`;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                result.className = 'result error';
                result.textContent = `âŒ è·å–æ¼«ç”»åˆ—è¡¨å¤±è´¥: ${error.message}`;
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥APIçŠ¶æ€
        window.onload = function() {
            checkStatus();
        };
    </script>
</body>
</html>