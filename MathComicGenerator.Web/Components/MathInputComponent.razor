@using MathComicGenerator.Shared.Models
@using MathComicGenerator.Shared.Services
@using System.ComponentModel.DataAnnotations
@inherits OptimizedComponentBase

<div class="math-input-container">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">知识点输入</h3>
            <p class="card-subtitle">请输入您想要生成漫画的任意知识点</p>
        </div>
        
        <div class="card-body">
            <EditForm Model="@inputModel" OnValidSubmit="@HandleSubmit">
                <DataAnnotationsValidator />
                
                <div class="form-group">
                    <label for="mathConcept" class="form-label">知识点内容</label>
                    <InputTextArea @bind-Value="inputModel.MathConcept" 
                                   class="@GetInputCssClass()"
                                   id="mathConcept"
                                   placeholder="请输入任意知识点，例如：加法运算、几何图形、分数概念、历史事件、科学原理等..."
                                   rows="3"
                                   maxlength="200" />
                    <ValidationMessage For="@(() => inputModel.MathConcept)" />
                    @if (!string.IsNullOrEmpty(validationMessage))
                    {
                        <div class="invalid-feedback d-block">@validationMessage</div>
                    }
                    <small class="form-text text-muted">支持任意学科的知识点，不限于数学概念</small>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="ageGroup" class="form-label">目标年龄组</label>
                            <InputSelect @bind-Value="inputModel.Options.AgeGroup" 
                                       class="form-select" id="ageGroup">
                                <option value="@AgeGroup.Preschool">学龄前 (5-6岁)</option>
                                <option value="@AgeGroup.Elementary">小学及以上 (6岁以上)</option>
                            </InputSelect>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="panelCount" class="form-label">面板数量</label>
                            <InputNumber @bind-Value="inputModel.Options.PanelCount" 
                                       class="form-control" 
                                       id="panelCount"
                                       min="3" 
                                       max="6" />
                            <small class="form-text text-muted">3-6个面板</small>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="visualStyle" class="form-label">视觉风格</label>
                            <InputSelect @bind-Value="inputModel.Options.VisualStyle" 
                                       class="form-select" id="visualStyle">
                                <option value="@VisualStyle.Cartoon">卡通风格</option>
                                <option value="@VisualStyle.Colorful">多彩风格</option>
                                <option value="@VisualStyle.Realistic">写实风格</option>
                                <option value="@VisualStyle.Minimalist">简约风格</option>
                            </InputSelect>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="language" class="form-label">语言</label>
                            <InputSelect @bind-Value="inputModel.Options.Language" 
                                       class="form-select" id="language">
                                <option value="@Language.Chinese">中文</option>
                                <option value="@Language.English">English</option>
                            </InputSelect>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group">
                            <div class="form-check">
                                <InputCheckbox @bind-Value="inputModel.Options.EnablePinyin" 
                                             class="form-check-input" id="enablePinyin" />
                                <label class="form-check-label" for="enablePinyin">
                                    为漫画文字添加拼音
                                </label>
                                <small class="form-text text-muted d-block">开启后，漫画中的中文文字将显示拼音，帮助儿童学习汉字读音</small>
                            </div>
                        </div>
                    </div>
                </div>

                @if (suggestions.Any())
                {
                    <div class="alert alert-info">
                        <h6>建议：</h6>
                        <ul class="mb-0">
                            @foreach (var suggestion in suggestions)
                            {
                                <li>@suggestion</li>
                            }
                        </ul>
                    </div>
                }

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" disabled="@isGenerating">
                        @if (isGenerating)
                        {
                            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                            <span>生成提示词中...</span>
                        }
                        else
                        {
                            <i class="fas fa-edit me-2"></i>
                            <span>生成提示词</span>
                        }
                    </button>
                    
                    <button type="button" class="btn btn-secondary ms-2" @onclick="HandleResetClick">
                        <i class="fas fa-undo me-2"></i>
                        重置
                    </button>
                </div>
            </EditForm>
        </div>
    </div>
</div>

@code {
    [Parameter] public EventCallback<ComicGenerationRequest> OnSubmit { get; set; }
    [Parameter] public bool IsGenerating { get; set; }

    private MathInputModel inputModel = new();
    private MathConceptValidator validator = new();
    private GenerationOptionsProcessor optionsProcessor = new();
    private string validationMessage = string.Empty;
    private List<string> suggestions = new();
    private bool isGenerating;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        
        // 设置默认值
        inputModel.Options = new GenerationOptions
        {
            AgeGroup = AgeGroup.Preschool,
            PanelCount = 4,
            VisualStyle = VisualStyle.Cartoon,
            Language = Language.Chinese,
            EnablePinyin = true
        };

        // 非阻塞的初始化日志
        _ = LogUserActionAsync("ComponentInitialized", new {
            defaultAgeGroup = inputModel.Options.AgeGroup.ToString(),
            defaultPanelCount = inputModel.Options.PanelCount
        });
    }

    protected override void OnParametersSet()
    {
        isGenerating = IsGenerating;
    }

    private async Task HandleSubmit()
    {
        await ExecuteWithPerformanceTrackingAsync("FormSubmit", async () =>
        {
            try
            {
                // 非阻塞的表单提交日志
                _ = LogUserActionAsync("FormSubmit", new {
                    mathConcept = inputModel.MathConcept,
                    conceptLength = inputModel.MathConcept?.Length ?? 0
                });

                validationMessage = string.Empty;
                suggestions.Clear();

                // 基本验证
                if (string.IsNullOrWhiteSpace(inputModel.MathConcept))
                {
                    validationMessage = "请输入知识点内容";
                    SafeStateHasChanged();
                    return;
                }

                if (inputModel.MathConcept.Length > 200)
                {
                    validationMessage = "知识点内容不能超过200个字符";
                    SafeStateHasChanged();
                    return;
                }

                // 创建数学概念对象
                var mathConcept = new MathConcept
                {
                    Topic = inputModel.MathConcept.Trim(),
                    AgeGroup = inputModel.Options.AgeGroup,
                    Difficulty = DifficultyLevel.Elementary,
                    Keywords = new List<string>()
                };

                // 创建生成请求
                var request = new ComicGenerationRequest
                {
                    MathConcept = mathConcept,
                    Options = inputModel.Options
                };

                // 触发提交事件
                await OnSubmit.InvokeAsync(request);
            }
            catch (Exception ex)
            {
                await LogErrorAsync("Error in form submission", ex);
                validationMessage = $"提交错误: {ex.Message}";
                SafeStateHasChanged();
            }
        });
    }

    private async Task HandleResetClick()
    {
        await ExecuteWithPerformanceTrackingAsync("FormReset", async () =>
        {
            _ = LogUserActionAsync("FormReset");
            
            inputModel = new MathInputModel();
            inputModel.Options = new GenerationOptions
            {
                AgeGroup = AgeGroup.Preschool,
                PanelCount = 4,
                VisualStyle = VisualStyle.Cartoon,
                Language = Language.Chinese,
                EnablePinyin = true
            };
            validationMessage = string.Empty;
            suggestions.Clear();

            SafeStateHasChanged();
        });
    }

    private bool HasValidationError(string fieldName)
    {
        return !string.IsNullOrEmpty(validationMessage) && validationMessage.Contains(fieldName);
    }

    private string GetInputCssClass()
    {
        return HasValidationError("MathConcept") ? "form-control is-invalid" : "form-control";
    }

    public class MathInputModel
    {
        [Required(ErrorMessage = "请输入知识点内容")]
        [StringLength(200, ErrorMessage = "知识点内容不能超过200个字符")]
        public string MathConcept { get; set; } = string.Empty;
        
        public GenerationOptions Options { get; set; } = new();
    }

    public class ComicGenerationRequest
    {
        public MathConcept MathConcept { get; set; } = new();
        public GenerationOptions Options { get; set; } = new();
    }
}
