@using MathComicGenerator.Shared.Models
@inject IJSRuntime JSRuntime

<div class="prompt-editor-container">
    <div class="card">
        <div class="card-header">
            <h4 class="card-title">
                <i class="fas fa-edit me-2"></i>
                提示词编辑器
            </h4>
            <p class="card-subtitle text-muted">
                您可以编辑AI生成的提示词，然后生成漫画图片
            </p>
        </div>
        
        <div class="card-body">
            @if (PromptResponse != null)
            {
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <label for="promptText" class="form-label fw-bold">生成的提示词</label>
                        <div class="btn-group btn-group-sm">
                            <button type="button" class="btn btn-outline-secondary" @onclick="OptimizePrompt" disabled="@isOptimizing">
                                @if (isOptimizing)
                                {
                                    <span class="spinner-border spinner-border-sm me-1"></span>
                                }
                                <i class="fas fa-magic me-1"></i>
                                优化提示词
                            </button>
                            <button type="button" class="btn btn-outline-info" @onclick="ResetPrompt">
                                <i class="fas fa-undo me-1"></i>
                                重置
                            </button>
                        </div>
                    </div>
                    
                    <textarea @bind="editedPrompt" 
                              @bind:event="oninput"
                              @bind:after="HandlePromptInputAfter"
                              @onfocus="HandlePromptFocus"
                              @onblur="HandlePromptBlur"
                              class="@GetPromptTextAreaClass()"
                              id="promptText"
                              rows="8"
                              placeholder="在这里编辑您的漫画创作提示词..."></textarea>
                    
                    <div class="form-text">
                        <small class="text-muted">
                            字符数: @editedPrompt.Length / 2000
                        </small>
                    </div>
                    
                    @if (!string.IsNullOrEmpty(validationMessage))
                    {
                        <div class="invalid-feedback d-block">
                            @validationMessage
                        </div>
                    }
                </div>

                @if (suggestions.Any())
                {
                    <div class="alert alert-info">
                        <h6><i class="fas fa-lightbulb me-2"></i>改进建议：</h6>
                        <ul class="mb-0">
                            @foreach (var suggestion in suggestions)
                            {
                                <li>@suggestion</li>
                            }
                        </ul>
                    </div>
                }

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">年龄组</label>
                        <select @bind="PromptResponse.Options.AgeGroup" class="form-select">
                            <option value="@AgeGroup.Preschool">学龄前 (5-6岁)</option>
                            <option value="@AgeGroup.Elementary">小学及以上 (6岁以上)</option>
                        </select>
                    </div>
                    
                    <div class="col-md-6">
                        <label class="form-label">面板数量</label>
                        <input type="number" @bind="PromptResponse.Options.PanelCount" 
                               class="form-control" min="3" max="6" />
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">视觉风格</label>
                        <select @bind="PromptResponse.Options.VisualStyle" class="form-select">
                            <option value="@VisualStyle.Cartoon">卡通风格</option>
                            <option value="@VisualStyle.Colorful">多彩风格</option>
                            <option value="@VisualStyle.Realistic">写实风格</option>
                            <option value="@VisualStyle.Minimalist">简约风格</option>
                        </select>
                    </div>
                    
                    <div class="col-md-6">
                        <label class="form-label">语言</label>
                        <select @bind="PromptResponse.Options.Language" class="form-select">
                            <option value="@Language.Chinese">中文</option>
                            <option value="@Language.English">English</option>
                        </select>
                    </div>
                </div>

                <div class="d-flex gap-2">
                    <button type="button" 
                            class="btn btn-primary" 
                            @onclick="GenerateComic" 
                            disabled="@(IsGenerating || !IsPromptValid())">
                        @if (IsGenerating)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                            <span>生成漫画中...</span>
                        }
                        else
                        {
                            <i class="fas fa-image me-2"></i>
                            <span>生成漫画图片</span>
                        }
                    </button>
                    
                    <button type="button" class="btn btn-secondary" @onclick="GoBack">
                        <i class="fas fa-arrow-left me-2"></i>
                        返回输入
                    </button>
                </div>
            }
            else
            {
                <div class="text-center text-muted">
                    <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                    <p>正在生成提示词...</p>
                </div>
            }
        </div>
    </div>
</div>

@code {
    [Parameter] public PromptGenerationResponse? PromptResponse { get; set; }
    [Parameter] public bool IsGenerating { get; set; }
    [Parameter] public EventCallback<ComicImageGenerationRequest> OnGenerateComic { get; set; }
    [Parameter] public EventCallback OnGoBack { get; set; }

    private string editedPrompt = string.Empty;
    private string originalPrompt = string.Empty;
    private string validationMessage = string.Empty;
    private List<string> suggestions = new();
    private bool isOptimizing = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("logInfo", "PromptEditorComponent initialized", new {
                hasPromptResponse = PromptResponse != null,
                isGenerating = IsGenerating,
                timestamp = DateTime.Now.ToString("HH:mm:ss")
            }, "COMPONENT_INIT");
        }
        catch (InvalidOperationException)
        {
            // Ignore JS interop errors during prerendering
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        try
        {
            if (PromptResponse != null && editedPrompt != PromptResponse.GeneratedPrompt)
            {
                var oldPrompt = editedPrompt;
                editedPrompt = PromptResponse.GeneratedPrompt;
                originalPrompt = PromptResponse.GeneratedPrompt;
                suggestions = PromptResponse.Suggestions;
                validationMessage = string.Empty;

                await JSRuntime.InvokeVoidAsync("logInfo", "Prompt loaded into editor", new {
                    promptId = PromptResponse.Id,
                    promptLength = editedPrompt.Length,
                    suggestionsCount = suggestions.Count,
                    ageGroup = PromptResponse.Options.AgeGroup.ToString(),
                    panelCount = PromptResponse.Options.PanelCount,
                    visualStyle = PromptResponse.Options.VisualStyle.ToString(),
                    language = PromptResponse.Options.Language.ToString(),
                    timestamp = DateTime.Now.ToString("HH:mm:ss")
                }, "PROMPT_LOAD");
            }

            await JSRuntime.InvokeVoidAsync("logInfo", "PromptEditorComponent parameters updated", new {
                hasPromptResponse = PromptResponse != null,
                isGenerating = IsGenerating,
                promptLength = editedPrompt.Length,
                timestamp = DateTime.Now.ToString("HH:mm:ss")
            }, "COMPONENT_UPDATE");
        }
        catch (InvalidOperationException)
        {
            // Ignore JS interop errors during prerendering
        }
    }

    private async Task GenerateComic()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("logUserClick", new {
                button = "generate_comic",
                action = "generate_comic_from_prompt",
                promptLength = editedPrompt.Length,
                isValid = IsPromptValid(),
                timestamp = DateTime.Now.ToString("HH:mm:ss")
            }, null);

            if (!IsPromptValid())
            {
                await JSRuntime.InvokeVoidAsync("logWarn", "Attempted to generate comic with invalid prompt", new {
                    promptLength = editedPrompt.Length,
                    validationMessage,
                    timestamp = DateTime.Now.ToString("HH:mm:ss")
                }, "PROMPT_VALIDATION");
                return;
            }

            var request = new ComicImageGenerationRequest
            {
                PromptId = PromptResponse?.Id ?? string.Empty,
                EditedPrompt = editedPrompt,
                Options = PromptResponse?.Options ?? new GenerationOptions()
            };

            await JSRuntime.InvokeVoidAsync("logInfo", "Generating comic from edited prompt", new {
                promptId = request.PromptId,
                editedPromptLength = request.EditedPrompt.Length,
                originalPromptLength = originalPrompt.Length,
                wasModified = editedPrompt != originalPrompt,
                options = new {
                    ageGroup = request.Options.AgeGroup.ToString(),
                    panelCount = request.Options.PanelCount,
                    visualStyle = request.Options.VisualStyle.ToString(),
                    language = request.Options.Language.ToString(),
                    enablePinyin = request.Options.EnablePinyin
                },
                timestamp = DateTime.Now.ToString("HH:mm:ss")
            }, "COMIC_GENERATION");

            await OnGenerateComic.InvokeAsync(request);
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("logError", "Error generating comic from prompt", ex.Message, "COMIC_GENERATION");
        }
    }

    private async Task GoBack()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("logUserClick", new {
                button = "go_back",
                action = "return_to_input",
                promptWasModified = editedPrompt != originalPrompt,
                timestamp = DateTime.Now.ToString("HH:mm:ss")
            }, null);

            await JSRuntime.InvokeVoidAsync("logInfo", "Returning to input form", new {
                promptWasModified = editedPrompt != originalPrompt,
                timestamp = DateTime.Now.ToString("HH:mm:ss")
            }, "NAVIGATION");

            await OnGoBack.InvokeAsync();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("logError", "Error going back to input", ex.Message, "NAVIGATION");
        }
    }

    private async Task OptimizePrompt()
    {
        if (PromptResponse == null) return;

        var startTime = DateTime.Now;

        try
        {
            await JSRuntime.InvokeVoidAsync("logUserClick", new {
                button = "optimize",
                action = "optimize_prompt",
                currentLength = editedPrompt.Length,
                timestamp = DateTime.Now.ToString("HH:mm:ss")
            }, null);

            await JSRuntime.InvokeVoidAsync("logInfo", "Starting prompt optimization", new {
                originalLength = editedPrompt.Length,
                promptId = PromptResponse.Id,
                timestamp = DateTime.Now.ToString("HH:mm:ss")
            }, "PROMPT_OPTIMIZATION");

            isOptimizing = true;
            StateHasChanged();

            // 这里应该调用API优化提示词
            // 暂时模拟优化过程
            await Task.Delay(2000);
            
            var oldPrompt = editedPrompt;
            
            // 实际实现中应该调用 /api/comic/optimize-prompt
            // var optimizedPrompt = await Http.PostAsJsonAsync("/api/comic/optimize-prompt", new { Prompt = editedPrompt, Options = PromptResponse.Options });
            
            // 模拟优化结果
            if (editedPrompt.Length < 100)
            {
                editedPrompt += "\n\n[Optimization] Added more visual detail descriptions, including character expressions, scene layout and color matching to make the comic more vivid and interesting.";
            }
            
            var duration = (DateTime.Now - startTime).TotalMilliseconds;
            
            await JSRuntime.InvokeVoidAsync("logInfo", "Prompt optimization completed", new {
                oldLength = oldPrompt.Length,
                newLength = editedPrompt.Length,
                duration = $"{duration}ms",
                timestamp = DateTime.Now.ToString("HH:mm:ss")
            }, "PROMPT_OPTIMIZATION");
            
            await ValidatePrompt();
        }
        catch (Exception ex)
        {
            var duration = (DateTime.Now - startTime).TotalMilliseconds;
            await JSRuntime.InvokeVoidAsync("logError", "Prompt optimization failed", ex.Message, "PROMPT_OPTIMIZATION");
            await JSRuntime.InvokeVoidAsync("logPerformance", "prompt_optimization_error", duration, new { error = ex.Message });
            validationMessage = $"Optimization failed: {ex.Message}";
        }
        finally
        {
            isOptimizing = false;
            StateHasChanged();
        }
    }

    private async Task ResetPrompt()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("logUserClick", new {
                button = "reset",
                action = "reset_prompt",
                currentLength = editedPrompt.Length,
                originalLength = originalPrompt.Length,
                timestamp = DateTime.Now.ToString("HH:mm:ss")
            }, null);

            var oldPrompt = editedPrompt;
            editedPrompt = originalPrompt;
            validationMessage = string.Empty;
            suggestions = PromptResponse?.Suggestions ?? new List<string>();

            await JSRuntime.InvokeVoidAsync("logInfo", "Prompt reset to original", new {
                oldLength = oldPrompt.Length,
                resetLength = editedPrompt.Length,
                timestamp = DateTime.Now.ToString("HH:mm:ss")
            }, "PROMPT_RESET");

            StateHasChanged();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("logError", "Error resetting prompt", ex.Message, "PROMPT_RESET");
        }
    }

    // Event handlers for console debugging
    private async Task HandlePromptInputAfter()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("logUserInput", "prompt_edit", editedPrompt.Length.ToString(), null);
            await JSRuntime.InvokeVoidAsync("logInfo", "Prompt text changed", new {
                length = editedPrompt.Length,
                wasModified = editedPrompt != originalPrompt,
                timestamp = DateTime.Now.ToString("HH:mm:ss")
            }, "PROMPT_EDIT");
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("logError", "Error logging prompt input", ex.Message, "INPUT_ERROR");
        }
    }

    private async Task HandlePromptFocus(FocusEventArgs e)
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("logInfo", "Prompt textarea focused", new {
                currentLength = editedPrompt.Length,
                isModified = editedPrompt != originalPrompt,
                timestamp = DateTime.Now.ToString("HH:mm:ss")
            }, "USER_FOCUS");
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("logError", "Error logging focus event", ex.Message, "FOCUS_ERROR");
        }
    }

    private async Task HandlePromptBlur(FocusEventArgs e)
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("logInfo", "Prompt textarea blurred", new {
                finalLength = editedPrompt.Length,
                isModified = editedPrompt != originalPrompt,
                timestamp = DateTime.Now.ToString("HH:mm:ss")
            }, "USER_BLUR");
            
            await ValidatePrompt();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("logError", "Error logging blur event", ex.Message, "BLUR_ERROR");
        }
    }

    private async Task ValidatePrompt()
    {
        try
        {
            validationMessage = string.Empty;
            suggestions.Clear();

            await JSRuntime.InvokeVoidAsync("logInfo", "Validating prompt", new {
                length = editedPrompt.Length,
                isEmpty = string.IsNullOrWhiteSpace(editedPrompt),
                timestamp = DateTime.Now.ToString("HH:mm:ss")
            }, "PROMPT_VALIDATION");

            if (string.IsNullOrWhiteSpace(editedPrompt))
            {
                validationMessage = "Prompt cannot be empty";
                await JSRuntime.InvokeVoidAsync("logValidation", "PromptEditor", "prompt", false, "Empty prompt");
                return;
            }

            if (editedPrompt.Length < 10)
            {
                validationMessage = "Prompt too short, please provide more detailed description";
                suggestions.Add("Add more descriptions about comic style, characters and scenes");
                await JSRuntime.InvokeVoidAsync("logValidation", "PromptEditor", "prompt", false, "Prompt too short");
            }
            else if (editedPrompt.Length > 2000)
            {
                validationMessage = "Prompt too long, please simplify description";
                suggestions.Add("Keep core elements, remove unnecessary details");
                await JSRuntime.InvokeVoidAsync("logValidation", "PromptEditor", "prompt", false, "Prompt too long");
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("logValidation", "PromptEditor", "prompt", true, null);
            }

            // 检查是否包含数学相关内容
            var mathKeywords = new[] { "math", "calculation", "formula", "graph", "number", "operation", "equation", "geometry", "algebra", "statistics", "数学", "计算", "公式", "图形", "数字", "运算", "方程", "几何", "代数", "统计" };
            var hasMathContent = mathKeywords.Any(keyword => editedPrompt.Contains(keyword, StringComparison.OrdinalIgnoreCase));
            
            if (!hasMathContent)
            {
                suggestions.Add("Suggest including math concept related keywords in the prompt");
            }

            // 检查是否包含漫画相关描述
            var comicKeywords = new[] { "comic", "panel", "character", "dialogue", "scene", "story", "plot", "漫画", "面板", "角色", "对话", "场景", "故事", "情节" };
            var hasComicContent = comicKeywords.Any(keyword => editedPrompt.Contains(keyword, StringComparison.OrdinalIgnoreCase));
            
            if (!hasComicContent)
            {
                suggestions.Add("Suggest adding comic structure and visual element descriptions");
            }

            await JSRuntime.InvokeVoidAsync("logInfo", "Prompt validation completed", new {
                isValid = IsPromptValid(),
                hasMathContent,
                hasComicContent,
                suggestionsCount = suggestions.Count,
                validationMessage,
                timestamp = DateTime.Now.ToString("HH:mm:ss")
            }, "PROMPT_VALIDATION");

            StateHasChanged();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("logError", "Error during prompt validation", ex.Message, "VALIDATION_ERROR");
        }
    }

    private bool IsPromptValid()
    {
        return !string.IsNullOrWhiteSpace(editedPrompt) && 
               editedPrompt.Length >= 10 && 
               editedPrompt.Length <= 2000 &&
               string.IsNullOrEmpty(validationMessage);
    }

    private string GetPromptTextAreaClass()
    {
        var baseClass = "form-control";
        
        if (!string.IsNullOrEmpty(validationMessage))
        {
            baseClass += " is-invalid";
        }
        else if (!string.IsNullOrWhiteSpace(editedPrompt) && IsPromptValid())
        {
            baseClass += " is-valid";
        }

        return baseClass;
    }
}

<style>
    .prompt-editor-container .card {
        border: 1px solid #e3e6f0;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
    }

    .prompt-editor-container .card-header {
        background-color: #f8f9fc;
        border-bottom: 1px solid #e3e6f0;
    }

    .prompt-editor-container textarea {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        line-height: 1.5;
        resize: vertical;
    }

    .prompt-editor-container .btn-group-sm .btn {
        font-size: 0.875rem;
    }

    .prompt-editor-container .alert-info {
        background-color: #d1ecf1;
        border-color: #bee5eb;
        color: #0c5460;
    }
</style>